<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View - Library Fine -->
    <record id="library_fine_view_form" model="ir.ui.view">
        <field name="name">library.fine.view.form</field>
        <field name="model">library.fine</field>
        <field name="arch" type="xml">
            <form string="Library Fine">
                <header>
                    <button name="action_mark_paid" type="object" string="Mark as Paid"
                            class="oe_highlight"
                            invisible="state != 'pending'"/>
                    <button name="action_waive" type="object" string="Waive Fine"
                            invisible="state != 'pending'"
                            confirm="Are you sure you want to waive this fine?"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="pending,paid"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Paid" bg_color="text-bg-success"
                            invisible="state != 'paid'"/>
                    <widget name="web_ribbon" title="Waived" bg_color="text-bg-info"
                            invisible="state != 'waived'"/>
                    <widget name="web_ribbon" title="Pending Payment" bg_color="text-bg-warning"
                            invisible="state != 'pending'"/>

                    <div class="oe_title">
                        <label for="name" string="Fine Number"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Member Details">
                            <field name="member_id"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="member_name" readonly="1"/>
                        </group>
                        <group string="Fine Details">
                            <field name="fine_type"/>
                            <field name="date" widget="date"/>
                            <field name="currency_id" invisible="1"/>
                            <field name="amount" widget="monetary"/>
                        </group>
                    </group>

                    <group string="Book Issue Reference" invisible="not issue_id">
                        <group>
                            <field name="issue_id"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="book_id" readonly="1"/>
                        </group>
                    </group>

                    <group string="Payment Details" invisible="state == 'pending'">
                        <group>
                            <field name="payment_date" widget="date"
                                   invisible="state != 'paid'"/>
                            <field name="payment_reference"
                                   invisible="state != 'paid'"
                                   placeholder="e.g., TXN123456789"/>
                        </group>
                    </group>

                    <group string="Waiver Details" invisible="state != 'waived'">
                        <group>
                            <field name="waived_by" readonly="1"/>
                            <field name="waiver_reason" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Reason/Notes" name="reason">
                            <field name="reason" nolabel="1"
                                   placeholder="Enter fine reason or additional notes..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- List View - Library Fine -->
    <record id="library_fine_view_list" model="ir.ui.view">
        <field name="name">library.fine.view.list</field>
        <field name="model">library.fine</field>
        <field name="arch" type="xml">
            <list string="Library Fines"
                  default_order="date desc"
                  multi_edit="1"
                  sample="1"
                  decoration-success="state == 'paid'"
                  decoration-info="state == 'waived'"
                  decoration-warning="state == 'pending'">
                <field name="name"/>
                <field name="member_id"/>
                <field name="member_name" optional="show"/>
                <field name="fine_type"/>
                <field name="issue_id" optional="show"/>
                <field name="book_id" optional="hide"/>
                <field name="date"/>
                <field name="amount" widget="monetary"/>
                <field name="payment_date" optional="show"/>
                <field name="payment_reference" optional="hide"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'paid'"
                       decoration-info="state == 'waived'"
                       decoration-warning="state == 'pending'"/>
            </list>
        </field>
    </record>

    <!-- Search View - Library Fine -->
    <record id="library_fine_view_search" model="ir.ui.view">
        <field name="name">library.fine.view.search</field>
        <field name="model">library.fine</field>
        <field name="arch" type="xml">
            <search string="Search Fines">
                <field name="name"/>
                <field name="member_id"/>
                <field name="member_name"/>
                <field name="issue_id"/>
                <field name="book_id"/>

                <separator/>

                <filter name="filter_overdue" string="Overdue Fine"
                        domain="[('fine_type', '=', 'overdue')]"/>
                <filter name="filter_damage" string="Damage Fine"
                        domain="[('fine_type', '=', 'damage')]"/>
                <filter name="filter_lost" string="Lost Book Fine"
                        domain="[('fine_type', '=', 'lost')]"/>
                <filter name="filter_other" string="Other Fine"
                        domain="[('fine_type', '=', 'other')]"/>

                <separator/>

                <filter name="filter_pending" string="Pending"
                        domain="[('state', '=', 'pending')]"/>
                <filter name="filter_paid" string="Paid"
                        domain="[('state', '=', 'paid')]"/>
                <filter name="filter_waived" string="Waived"
                        domain="[('state', '=', 'waived')]"/>

                <separator/>

                <filter name="filter_today" string="Today"
                        domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_week" string="This Week"
                        domain="[('date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_month" string="This Month"
                        domain="[('date', '&gt;=', (context_today() + relativedelta(day=1)).strftime('%Y-%m-%d')),
                                 ('date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]"/>

                <group expand="0" string="Group By">
                    <filter name="group_by_member" string="Member"
                            context="{'group_by': 'member_id'}"/>
                    <filter name="group_by_fine_type" string="Fine Type"
                            context="{'group_by': 'fine_type'}"/>
                    <filter name="group_by_state" string="Status"
                            context="{'group_by': 'state'}"/>
                    <filter name="group_by_date" string="Fine Date"
                            context="{'group_by': 'date'}"/>
                </group>

                <searchpanel>
                    <field name="fine_type" string="Fine Type"
                           select="multi"
                           icon="fa-money"/>
                    <field name="state" string="Status"
                           select="multi"
                           icon="fa-filter"/>
                </searchpanel>
            </search>
        </field>
    </record>

    <!-- Kanban View - Library Fine -->
    <record id="library_fine_view_kanban" model="ir.ui.view">
        <field name="name">library.fine.view.kanban</field>
        <field name="model">library.fine</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile"
                    default_group_by="state"
                    quick_create="false"
                    sample="1">
                <field name="id"/>
                <field name="name"/>
                <field name="member_id"/>
                <field name="member_name"/>
                <field name="fine_type"/>
                <field name="issue_id"/>
                <field name="book_id"/>
                <field name="date"/>
                <field name="amount"/>
                <field name="payment_date"/>
                <field name="state"/>

                <progressbar field="state"
                             colors='{"pending": "warning", "paid": "success", "waived": "info"}'/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'paid'">
                                <span class="text-bg-success">Paid</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'waived'">
                                <span class="text-bg-info">Waived</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'pending'">
                                <span class="text-bg-warning">Pending</span>
                            </div>

                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="member_name"/>
                                        </strong>
                                        <div class="text-muted">
                                            <field name="name"/>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body mt-3">
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="bg-light p-2 rounded">
                                                <div class="mb-1">
                                                    <i class="fa fa-money text-danger"/>
                                                    <strong>Fine Type:</strong> <field name="fine_type"/>
                                                </div>
                                                <div class="mb-1" t-if="record.book_id.raw_value">
                                                    <i class="fa fa-book text-info"/>
                                                    <strong>Book:</strong> <field name="book_id"/>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fa fa-calendar text-warning"/>
                                                    <strong>Date:</strong> <field name="date"/>
                                                </div>
                                                <div t-if="record.payment_date.raw_value and record.state.raw_value == 'paid'">
                                                    <i class="fa fa-check-circle text-success"/>
                                                    <strong>Paid On:</strong> <field name="payment_date"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12 text-center">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body p-3">
                                                    <h2 class="mb-0">â‚¹<field name="amount"/></h2>
                                                    <small>Fine Amount</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="state" widget="badge"
                                               decoration-success="state == 'paid'"
                                               decoration-info="state == 'waived'"
                                               decoration-warning="state == 'pending'"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Calendar View - Library Fine -->
    <record id="library_fine_view_calendar" model="ir.ui.view">
        <field name="name">library.fine.view.calendar</field>
        <field name="model">library.fine</field>
        <field name="arch" type="xml">
            <calendar string="Fine Calendar"
                      date_start="date"
                      color="state"
                      mode="month"
                      quick_create="0"
                      event_open_popup="1">
                <field name="member_id"/>
                <field name="fine_type"/>
                <field name="amount"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Action -->
    <record id="action_library_fine" model="ir.actions.act_window">
        <field name="name">Library Fines</field>
        <field name="res_model">library.fine</field>
        <field name="view_mode">list,kanban,form,calendar</field>
        <field name="context">{'search_default_filter_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Record Library Fine
            </p>
            <p>
                Manage library fines for overdue books, damages, and losses. System automatically assigns
                unique fine numbers using sequence. Select member (library.member, required, tracked,
                indexed). Optionally link to book issue (library.issue) for overdue fines. Choose fine
                type: Overdue Fine (late return), Damage Fine (book damage), Lost Book Fine (book not
                returned), Other (miscellaneous penalties). Enter fine amount (monetary, required, tracked).
                Set fine date (default today). 3-state system: Pending (awaiting payment), Paid (payment
                received), Waived (fine forgiven). Two action buttons: "Mark as Paid" (sets state='paid' +
                payment_date=today, visible only in pending state), "Waive Fine" (sets state='waived' +
                waived_by=current_user, visible only in pending state, with confirmation). Track payment
                details (payment_date, payment_reference). Track waiver details (waived_by user,
                waiver_reason). Add reason/notes for fine. Full chatter support for communication.
            </p>
        </field>
    </record>

    <!-- Menu Item -->
<!--    <menuitem id="menu_library_fine"-->
<!--              name="Fines"-->
<!--              parent="menu_library_root"-->
<!--              action="action_library_fine"-->
<!--              sequence="50"/>-->

</odoo>
