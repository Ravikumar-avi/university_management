<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View - Hostel Attendance -->
    <record id="hostel_attendance_view_form" model="ir.ui.view">
        <field name="name">hostel.attendance.view.form</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <form string="Hostel Attendance">
                <header>
                    <field name="state" widget="statusbar"
                           statusbar_visible="present,absent,out,leave"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Present" bg_color="text-bg-success"
                            invisible="state != 'present'"/>
                    <widget name="web_ribbon" title="Absent" bg_color="text-bg-danger"
                            invisible="state != 'absent'"/>
                    <widget name="web_ribbon" title="Out with Permission" bg_color="text-bg-warning"
                            invisible="state != 'out'"/>
                    <widget name="web_ribbon" title="On Leave" bg_color="text-bg-info"
                            invisible="state != 'leave'"/>

                    <div class="oe_title">
                        <label for="name" string="Reference"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Student Information">
                            <field name="student_id"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="allocation_id"
                                   domain="[('student_id', '=', student_id), ('state', '=', 'allocated')]"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                        </group>
                        <group string="Hostel &amp; Room Details">
                            <field name="hostel_id" readonly="1"/>
                            <field name="room_id" readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group string="Attendance Details">
                            <field name="date" widget="date"/>
                        </group>
                    </group>

                    <group invisible="state != 'out'">
                        <group string="Out Pass Details">
                            <field name="out_time" widget="datetime"/>
                            <field name="expected_return" widget="datetime"/>
                            <field name="actual_return" widget="datetime"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Remarks" name="remarks">
                            <field name="remarks" nolabel="1"
                                   placeholder="Enter any remarks or additional information..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- List View - Hostel Attendance -->
    <record id="hostel_attendance_view_list" model="ir.ui.view">
        <field name="name">hostel.attendance.view.list</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <list string="Hostel Attendance"
                  default_order="date desc, hostel_id"
                  multi_edit="1"
                  sample="1"
                  decoration-success="state == 'present'"
                  decoration-danger="state == 'absent'"
                  decoration-warning="state == 'out'"
                  decoration-info="state == 'leave'">
                <field name="date"/>
                <field name="student_id"/>
                <field name="hostel_id"/>
                <field name="room_id" optional="show"/>
                <field name="allocation_id" optional="hide"/>
                <field name="out_time" widget="datetime" optional="hide"/>
                <field name="expected_return" widget="datetime" optional="hide"/>
                <field name="actual_return" widget="datetime" optional="hide"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'present'"
                       decoration-danger="state == 'absent'"
                       decoration-warning="state == 'out'"
                       decoration-info="state == 'leave'"/>
            </list>
        </field>
    </record>

    <!-- Search View - Hostel Attendance -->
    <record id="hostel_attendance_view_search" model="ir.ui.view">
        <field name="name">hostel.attendance.view.search</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <search string="Search Attendance">
                <field name="student_id"/>
                <field name="hostel_id"/>
                <field name="room_id"/>
                <field name="allocation_id"/>
                <field name="date"/>

                <separator/>

                <filter name="filter_present" string="Present"
                        domain="[('state', '=', 'present')]"/>
                <filter name="filter_absent" string="Absent"
                        domain="[('state', '=', 'absent')]"/>
                <filter name="filter_out" string="Out with Permission"
                        domain="[('state', '=', 'out')]"/>
                <filter name="filter_leave" string="On Leave"
                        domain="[('state', '=', 'leave')]"/>

                <separator/>

                <filter name="filter_today" string="Today"
                        domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_yesterday" string="Yesterday"
                        domain="[('date', '=', (context_today() - datetime.timedelta(days=1)).strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_week" string="This Week"
                        domain="[('date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_month" string="This Month"
                        domain="[('date', '&gt;=', (context_today() + relativedelta(day=1)).strftime('%Y-%m-%d')),
                                 ('date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]"/>

                <separator/>

                <filter name="filter_not_returned" string="Not Returned (Out)"
                        domain="[('state', '=', 'out'), ('actual_return', '=', False)]"/>
                <filter name="filter_late_return" string="Late Return"
                        domain="[('state', '=', 'out'), ('actual_return', '&gt;', expected_return)]"/>

                <group expand="0" string="Group By">
                    <filter name="group_by_student" string="Student"
                            context="{'group_by': 'student_id'}"/>
                    <filter name="group_by_hostel" string="Hostel"
                            context="{'group_by': 'hostel_id'}"/>
                    <filter name="group_by_room" string="Room"
                            context="{'group_by': 'room_id'}"/>
                    <filter name="group_by_state" string="Status"
                            context="{'group_by': 'state'}"/>
                    <filter name="group_by_date" string="Date"
                            context="{'group_by': 'date'}"/>
                </group>

                <searchpanel>
                    <field name="hostel_id" string="Hostel"
                           select="multi"
                           icon="fa-building"/>
                    <field name="state" string="Status"
                           select="multi"
                           icon="fa-filter"/>
                </searchpanel>
            </search>
        </field>
    </record>

    <!-- Kanban View - Hostel Attendance -->
    <record id="hostel_attendance_view_kanban" model="ir.ui.view">
        <field name="name">hostel.attendance.view.kanban</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile"
                    default_group_by="state"
                    quick_create="false"
                    sample="1">
                <field name="id"/>
                <field name="name"/>
                <field name="student_id"/>
                <field name="allocation_id"/>
                <field name="hostel_id"/>
                <field name="room_id"/>
                <field name="date"/>
                <field name="out_time"/>
                <field name="expected_return"/>
                <field name="actual_return"/>
                <field name="state"/>

                <progressbar field="state"
                             colors='{"present": "success", "absent": "danger", "out": "warning", "leave": "info"}'/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'present'">
                                <span class="text-bg-success">Present</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'absent'">
                                <span class="text-bg-danger">Absent</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'out'">
                                <span class="text-bg-warning">Out</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'leave'">
                                <span class="text-bg-info">Leave</span>
                            </div>

                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="student_id"/>
                                        </strong>
                                        <div class="text-muted">
                                            <field name="date"/>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body mt-3">
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="bg-light p-2 rounded">
                                                <div class="mb-1" t-if="record.hostel_id.raw_value">
                                                    <i class="fa fa-building text-primary"/>
                                                    <strong>Hostel:</strong> <field name="hostel_id"/>
                                                </div>
                                                <div class="mb-1" t-if="record.room_id.raw_value">
                                                    <i class="fa fa-home text-success"/>
                                                    <strong>Room:</strong> <field name="room_id"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-2" t-if="record.state.raw_value == 'out'">
                                        <div class="col-12">
                                            <div class="bg-light p-2 rounded">
                                                <div class="mb-1" t-if="record.out_time.raw_value">
                                                    <i class="fa fa-sign-out text-danger"/>
                                                    <strong>Out:</strong> <field name="out_time" widget="datetime"/>
                                                </div>
                                                <div class="mb-1" t-if="record.expected_return.raw_value">
                                                    <i class="fa fa-clock-o text-warning"/>
                                                    <strong>Expected:</strong> <field name="expected_return" widget="datetime"/>
                                                </div>
                                                <div class="mb-1" t-if="record.actual_return.raw_value">
                                                    <i class="fa fa-sign-in text-success"/>
                                                    <strong>Returned:</strong> <field name="actual_return" widget="datetime"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="state" widget="badge"
                                               decoration-success="state == 'present'"
                                               decoration-danger="state == 'absent'"
                                               decoration-warning="state == 'out'"
                                               decoration-info="state == 'leave'"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Calendar View - Hostel Attendance -->
    <record id="hostel_attendance_view_calendar" model="ir.ui.view">
        <field name="name">hostel.attendance.view.calendar</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <calendar string="Attendance Calendar"
                      date_start="date"
                      color="state"
                      mode="month"
                      quick_create="0"
                      event_open_popup="1">
                <field name="student_id"/>
                <field name="hostel_id"/>
                <field name="state"/>
            </calendar>
        </field>
    </record>

    <!-- Pivot View - Hostel Attendance -->
    <record id="hostel_attendance_view_pivot" model="ir.ui.view">
        <field name="name">hostel.attendance.view.pivot</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <pivot string="Attendance Analysis">
                <field name="date" type="row" interval="day"/>
                <field name="hostel_id" type="row"/>
                <field name="state" type="col"/>
            </pivot>
        </field>
    </record>

    <!-- Graph View - Hostel Attendance -->
    <record id="hostel_attendance_view_graph" model="ir.ui.view">
        <field name="name">hostel.attendance.view.graph</field>
        <field name="model">hostel.attendance</field>
        <field name="arch" type="xml">
            <graph string="Attendance Statistics" type="bar">
                <field name="date" interval="day"/>
                <field name="state" type="col"/>
            </graph>
        </field>
    </record>

    <!-- Action -->
    <record id="action_hostel_attendance" model="ir.actions.act_window">
        <field name="name">Hostel Attendance</field>
        <field name="res_model">hostel.attendance</field>
        <field name="view_mode">list,kanban,calendar,form,pivot,graph</field>
        <field name="context">{'search_default_filter_today': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Mark Hostel Attendance
            </p>
            <p>
                Manage daily hostel student attendance. System computes reference name (student_id.name -
                date, stored). Select student (student.student, required, indexed). Select allocation_id
                (hostel.allocation, domain filters by student_id and state='allocated', shows only active
                allocations for selected student). System auto-fills hostel_id (related from
                allocation_id.hostel_id, stored, readonly) and room_id (related from allocation_id.room_id,
                stored, readonly). Enter date (default today, required, indexed). Select status (4 options,
                default 'present', required, tracked): Present (student in hostel, green), Absent (student
                missing, red), Out with Permission (student out with approved pass, yellow, shows out pass
                details section), On Leave (student on approved leave, blue). Out pass details (visible
                only when status='out'): out_time (datetime when left), expected_return (datetime when
                expected back), actual_return (datetime when actually returned, for late return tracking).
                Unique constraint: Only one attendance record per student per date. Calendar view shows
                attendance by date (color by status). Pivot/graph views for attendance analysis. Add
                remarks for additional information. Full chatter support for communication and tracking.
            </p>
        </field>
    </record>

    <!-- Menu Item -->
<!--    <menuitem id="menu_hostel_attendance"-->
<!--              name="Attendance"-->
<!--              parent="menu_hostel_root"-->
<!--              action="action_hostel_attendance"-->
<!--              sequence="40"/>-->

</odoo>
