<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form View -->
    <record id="examination_hall_ticket_view_form" model="ir.ui.view">
        <field name="name">examination.hall.ticket.view.form</field>
        <field name="model">examination.hall.ticket</field>
        <field name="arch" type="xml">
            <form string="Hall Ticket">
                <header>
                    <button name="action_issue" type="object" string="Issue Hall Ticket"
                            class="oe_highlight"
                            invisible="state != 'draft' or not is_eligible"/>
                    <button name="action_print" type="object" string="Print Hall Ticket"
                            class="oe_highlight"
                            invisible="state not in ['issued', 'downloaded']"/>
                    <button name="action_download" type="object" string="Download"
                            invisible="state not in ['issued', 'downloaded']"/>
                    <button name="action_cancel" type="object" string="Cancel"
                            invisible="state in ['cancelled']"
                            confirm="Are you sure you want to cancel this hall ticket?"/>
                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,issued,downloaded,printed"/>
                </header>
                <sheet>
                    <widget name="web_ribbon" title="Not Eligible" bg_color="text-bg-danger"
                            invisible="is_eligible"/>
                    <widget name="web_ribbon" title="Downloaded" bg_color="text-bg-info"
                            invisible="state != 'downloaded'"/>
                    <widget name="web_ribbon" title="Printed" bg_color="text-bg-success"
                            invisible="state != 'printed'"/>
                    <widget name="web_ribbon" title="Cancelled" bg_color="text-bg-danger"
                            invisible="state != 'cancelled'"/>

                    <div class="oe_title">
                        <label for="name" string="Hall Ticket Number"/>
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Student Details">
                            <field name="student_id"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="registration_number" readonly="1"/>
                            <field name="student_name" readonly="1"/>
                            <field name="program_id" readonly="1"/>
                            <field name="department_id" readonly="1"/>
                            <field name="batch_id" readonly="1"/>
                        </group>
                        <group string="Student Photo &amp; QR Code">
                            <field name="student_photo" widget="image"
                                   options="{'size': [150, 150]}"
                                   readonly="1"/>
                            <field name="qr_code" widget="image"
                                   options="{'size': [150, 150]}"
                                   readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group string="Examination Details">
                            <field name="examination_id"
                                   options="{'no_create': True, 'no_create_edit': True}"/>
                            <field name="academic_year_id" readonly="1"/>
                            <field name="semester_id" readonly="1"/>
                        </group>
                        <group string="Issue Details">
                            <field name="issue_date" widget="date"/>
                            <field name="issued_by" readonly="1"/>
                        </group>
                    </group>

                    <group>
                        <group string="Eligibility">
                            <field name="is_eligible" widget="boolean_toggle"/>
                            <field name="ineligibility_reason"
                                   placeholder="Reason for ineligibility..."
                                   invisible="is_eligible"/>
                        </group>
                        <group string="Download Statistics">
                            <field name="download_count" readonly="1"/>
                            <field name="last_downloaded" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Exam Schedule" name="exam_schedule">
                            <field name="exam_timetable_ids" widget="many2many"
                                   domain="[('examination_id', '=', examination_id)]">
                                <list string="Exam Schedule">
                                    <field name="subject_id"/>
                                    <field name="exam_date"/>
                                    <field name="start_time" widget="float_time"/>
                                    <field name="end_time" widget="float_time"/>
                                    <field name="venue"/>
                                    <field name="room_numbers"/>
                                </list>
                            </field>
                        </page>

                        <page string="Instructions" name="instructions">
                            <field name="instructions" readonly="1"/>
                        </page>

                        <page string="Technical Details" name="technical">
                            <group>
                                <field name="qr_data" readonly="1"/>
                            </group>
                        </page>

                        <page string="Notes" name="notes">
                            <field name="notes"
                                   placeholder="Enter any notes or remarks..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- List View -->
    <record id="examination_hall_ticket_view_list" model="ir.ui.view">
        <field name="name">examination.hall.ticket.view.list</field>
        <field name="model">examination.hall.ticket</field>
        <field name="arch" type="xml">
            <list string="Hall Tickets"
                  default_order="issue_date desc"
                  multi_edit="1"
                  sample="1"
                  decoration-success="state == 'printed'"
                  decoration-info="state == 'downloaded'"
                  decoration-warning="state == 'issued'"
                  decoration-danger="not is_eligible or state == 'cancelled'"
                  decoration-muted="state == 'draft'">
                <field name="name"/>
                <field name="student_id"/>
                <field name="registration_number" optional="show"/>
                <field name="examination_id"/>
                <field name="program_id" optional="hide"/>
                <field name="department_id" optional="show"/>
                <field name="semester_id" optional="show"/>
                <field name="issue_date"/>
                <field name="issued_by" optional="hide"/>
                <field name="is_eligible" widget="boolean_toggle"/>
                <field name="download_count" optional="hide"/>
                <field name="last_downloaded" optional="hide"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'printed'"
                       decoration-info="state == 'downloaded'"
                       decoration-warning="state == 'issued'"
                       decoration-danger="state == 'cancelled'"/>
            </list>
        </field>
    </record>

    <!-- Search View -->
    <record id="examination_hall_ticket_view_search" model="ir.ui.view">
        <field name="name">examination.hall.ticket.view.search</field>
        <field name="model">examination.hall.ticket</field>
        <field name="arch" type="xml">
            <search string="Search Hall Tickets">
                <field name="name"/>
                <field name="student_id"/>
                <field name="registration_number"/>
                <field name="examination_id"/>
                <field name="department_id"/>

                <separator/>

                <filter name="filter_eligible" string="Eligible Students"
                        domain="[('is_eligible', '=', True)]"/>
                <filter name="filter_not_eligible" string="Not Eligible"
                        domain="[('is_eligible', '=', False)]"/>

                <separator/>

                <filter name="filter_draft" string="Draft"
                        domain="[('state', '=', 'draft')]"/>
                <filter name="filter_issued" string="Issued"
                        domain="[('state', '=', 'issued')]"/>
                <filter name="filter_downloaded" string="Downloaded"
                        domain="[('state', '=', 'downloaded')]"/>
                <filter name="filter_printed" string="Printed"
                        domain="[('state', '=', 'printed')]"/>
                <filter name="filter_cancelled" string="Cancelled"
                        domain="[('state', '=', 'cancelled')]"/>

                <separator/>

                <filter name="filter_today" string="Issued Today"
                        domain="[('issue_date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_week" string="Issued This Week"
                        domain="[('issue_date', '&gt;=', (context_today() - datetime.timedelta(days=context_today().weekday())).strftime('%Y-%m-%d')),
                                 ('issue_date', '&lt;=', (context_today() + datetime.timedelta(days=6-context_today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_month" string="Issued This Month"
                        domain="[('issue_date', '&gt;=', (context_today() + relativedelta(day=1)).strftime('%Y-%m-%d')),
                                 ('issue_date', '&lt;=', (context_today() + relativedelta(day=31)).strftime('%Y-%m-%d'))]"/>

                <separator/>

                <filter name="filter_downloaded_hall_tickets" string="Downloaded Hall Tickets"
                        domain="[('download_count', '&gt;', 0)]"/>
                <filter name="filter_not_downloaded" string="Not Downloaded"
                        domain="[('download_count', '=', 0), ('state', 'in', ['issued', 'downloaded', 'printed'])]"/>

                <group expand="0" string="Group By">
                    <filter name="group_by_examination" string="Examination"
                            context="{'group_by': 'examination_id'}"/>
                    <filter name="group_by_student" string="Student"
                            context="{'group_by': 'student_id'}"/>
                    <filter name="group_by_department" string="Department"
                            context="{'group_by': 'department_id'}"/>
                    <filter name="group_by_semester" string="Semester"
                            context="{'group_by': 'semester_id'}"/>
                    <filter name="group_by_state" string="Status"
                            context="{'group_by': 'state'}"/>
                    <filter name="group_by_eligibility" string="Eligibility"
                            context="{'group_by': 'is_eligible'}"/>
                    <filter name="group_by_issue_date" string="Issue Date"
                            context="{'group_by': 'issue_date'}"/>
                </group>

                <searchpanel>
                    <field name="examination_id" string="Examination"
                           select="multi"
                           icon="fa-graduation-cap"/>
                    <field name="department_id" string="Department"
                           select="multi"
                           icon="fa-building"/>
                    <field name="semester_id" string="Semester"
                           select="multi"
                           icon="fa-list-ol"/>
                    <field name="state" string="Status"
                           select="multi"
                           icon="fa-filter"/>
                </searchpanel>
            </search>
        </field>
    </record>

    <!-- Kanban View -->
    <record id="examination_hall_ticket_view_kanban" model="ir.ui.view">
        <field name="name">examination.hall.ticket.view.kanban</field>
        <field name="model">examination.hall.ticket</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile"
                    default_group_by="state"
                    quick_create="false"
                    sample="1">
                <field name="id"/>
                <field name="name"/>
                <field name="student_id"/>
                <field name="registration_number"/>
                <field name="student_name"/>
                <field name="student_photo"/>
                <field name="examination_id"/>
                <field name="program_id"/>
                <field name="department_id"/>
                <field name="semester_id"/>
                <field name="issue_date"/>
                <field name="is_eligible"/>
                <field name="ineligibility_reason"/>
                <field name="download_count"/>
                <field name="last_downloaded"/>
                <field name="qr_code"/>
                <field name="state"/>

                <progressbar field="state"
                             colors='{"draft": "secondary", "issued": "warning", "downloaded": "info", "printed": "success", "cancelled": "danger"}'/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="ribbon ribbon-top-right" t-if="!record.is_eligible.raw_value">
                                <span class="text-bg-danger">Not Eligible</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'downloaded' and record.is_eligible.raw_value">
                                <span class="text-bg-info">Downloaded</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'printed' and record.is_eligible.raw_value">
                                <span class="text-bg-success">Printed</span>
                            </div>
                            <div class="ribbon ribbon-top-right" t-if="record.state.raw_value == 'cancelled'">
                                <span class="text-bg-danger">Cancelled</span>
                            </div>

                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="student_name"/>
                                        </strong>
                                        <div class="text-muted">
                                            <field name="name"/>
                                        </div>
                                        <div class="text-muted">
                                            Reg: <field name="registration_number"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_top_right">
                                        <field name="student_photo" widget="image"
                                               options="{'size': [80, 80]}"
                                               class="oe_avatar"/>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body mt-3">
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="bg-light p-2 rounded">
                                                <div class="mb-1">
                                                    <i class="fa fa-graduation-cap text-primary"/>
                                                    <strong><field name="examination_id"/></strong>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fa fa-building text-info"/>
                                                    <field name="department_id"/>
                                                </div>
                                                <div class="mb-1">
                                                    <i class="fa fa-list-ol text-success"/>
                                                    Semester: <field name="semester_id"/>
                                                </div>
                                                <div>
                                                    <i class="fa fa-calendar text-warning"/>
                                                    Issued: <field name="issue_date"/>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-2" t-if="record.download_count.raw_value &gt; 0">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <small class="text-muted">
                                                    <i class="fa fa-download"/> Downloads:
                                                </small>
                                                <span class="badge text-bg-info">
                                                    <strong><field name="download_count"/></strong>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-2" t-if="!record.is_eligible.raw_value">
                                        <div class="col-12">
                                            <div class="alert alert-danger mb-0 py-2">
                                                <small>
                                                    <i class="fa fa-exclamation-triangle"/>
                                                    <strong>Not Eligible:</strong>
                                                    <field name="ineligibility_reason"/>
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mt-3" t-if="record.qr_code.raw_value">
                                        <div class="col-12 text-center">
                                            <field name="qr_code" widget="image"
                                                   options="{'size': [100, 100]}"/>
                                            <div><small class="text-muted">Scan QR Code</small></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="state" widget="badge"
                                               decoration-success="state == 'printed'"
                                               decoration-info="state == 'downloaded'"
                                               decoration-warning="state == 'issued'"
                                               decoration-danger="state == 'cancelled'"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="activity_ids" widget="kanban_activity"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Action -->
    <record id="action_examination_hall_ticket" model="ir.actions.act_window">
        <field name="name">Hall Tickets</field>
        <field name="res_model">examination.hall.ticket</field>
        <field name="view_mode">list,kanban,form</field>
        <field name="context">{'search_default_filter_eligible': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Generate Hall Ticket
            </p>
            <p>
                Generate hall tickets for examination. System automatically assigns unique hall
                ticket numbers using sequence. Links student to examination with all academic
                details (program/department/batch/semester). Select exam subjects from timetable
                via many2many relation. Automatically generates QR code containing hall ticket
                number, registration number, student name, and examination name for quick
                verification. Track eligibility based on attendance (≥75%), fee dues (0), and
                discipline issues (no major/critical pending). 5-state workflow: Draft → Issued →
                Downloaded → Printed → Cancelled. Issue action sends email to student. Download
                and print actions track usage statistics (count, last downloaded datetime). Portal
                mixin provides student portal access. Unique constraints prevent duplicate hall
                ticket numbers and multiple hall tickets for same student-examination combination.
            </p>
        </field>
    </record>

    <!-- Menu Item -->
<!--    <menuitem id="menu_examination_hall_ticket"-->
<!--              name="Hall Tickets"-->
<!--              parent="menu_examination_root"-->
<!--              action="action_examination_hall_ticket"-->
<!--              sequence="30"/>-->

</odoo>
